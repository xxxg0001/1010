var DCAgentInitConfig=function(){},DCAgentPaymentConfig=function(){};!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("DCAgent",["exports"],t):t(e.DCAgent={})}(this,function(e){function t(){}function n(e){var t,n;return t=Date.now(),n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n;return n=(t+16*Math.random())%16|0,t=Math.floor(t/16),"x"===e?n.toString(16):(7&n|8).toString(16)}),(e||"")+n.replace(/-/g,"").toUpperCase()}function r(e){var t,n;for(t in e)n=e[t],e[t]=n;return(2<=arguments.length?[].slice.call(arguments,1):[]).forEach(function(r){var a;a=[];for(t in r)n=r[t],a.push(e[t]=n);return a}),e}function a(e,t,n){if("function"==typeof e)try{return e.apply(t,n)}catch(r){i("attemp error for "+e.toString(),r.stack)}}function o(e,t,n){function r(){!1!==a(e)&&G(r,t)}n?r():G(r,t)}function i(e,t){console.log("#DCAgent: "+e),t&&console.log(t)}function c(e,t){return e=s(e),z.setItem(e,t),lt.set(e,t,365),t}function u(e){return e=s(e),z.getItem(e)||lt.get(e)}function s(e){return B||at===e?e:(k.appId||i("appid should not be empty when you are in native env"),k.appId+"."+e)}function d(e){var t=L.hash,n="!"+e;if(t){var r=/![0-9A-Z]{32,128}/gi;(t=t.match(r))?(t=t[0].slice(1),e===t||u($)||(k.parentId=t,c($,t)),L.href=L.href.replace(r,n)):L.href+=n}else L.href+="#"+n}function l(e,t,n,r){var a={data:{online:{},events:e||[],errors:t||[]},success:r};n&&(a.data.reg=n),e=h(et),t=h(tt),(e.length||t.length)&&(z.removeItem(s(et)),z.removeItem(s(tt)),a.data.events=a.data.events.concat(e),a.data.errors=a.data.errors.concat(t),a.error=function(){k.debug&&i("report failed, restoring data to localStorage"),y(a.data.events,et),y(a.data.errors,tt)}),v(a,ot)}function f(e,t,n){e={page:encodeURIComponent(e||vt),optime:parseInt(k.initializedOn),ottime:parseInt(Date.now()/1e3),lttime:parseInt(k.loginTime/1e3)},l([{eventid:"_DESelf_PV",labelmap:JSON.stringify(e),duration:"1"}],null,t,function(){mt+=1,a(n)})}function g(){if(!k.appId||!k.accountId||!k.deviceId)return i("DCAgent.init failed, check your options"),{};var e=k.intervalCount*k.interval/1e3||1;return{appid:k.appId,accountid:k.accountId,uid:k.deviceId,appver:k.appVer,ver:ht,channel:k.channel,domain:It,screen:yt,logintime:String(parseInt(k.loginTime/1e3)),onlinetime:String(e),crtime:u(Z)||"",pv:mt.toString()}}function p(e){var t=new N.XMLHttpRequest;t.timeout=ut,t.open("POST",e.url,!0),t.setRequestHeader("Content-Type","text/plain; charset=UTF-8");var n=Date.now();t.onreadystatechange=function(){if(4===this.readyState){var t=200<=this.status&&300>this.status,r=Date.now()-n;a(t?e.success:e.error,this,[this,r]),a(e.complete,this,[this,r]),this.timeout=this.onreadystatechange=null}},t.timeout=function(){var t=Date.now()-n;a(e.error,this,[this,t,!0]),a(e.complete,this,[this,t]),this.timeout=this.onreadystatechange=null},t.send(JSON.stringify(e.data))}function m(e){var t=new egret.URLLoader,n=Date.now();t.addEventListener(egret.Event.COMPLETE,function(t){var r=Date.now()-n;t=t.target,a("success"===t.data?e.success:e.error,t,[t,r,r>=ut]),a(e.complete,t,[t,r])});var r=new egret.URLRequest(e.url);r.method=egret.URLRequestMethod.POST,r.data=JSON.stringify(e.data),t.load(r)}function v(e,t){if(e.data){e.data.errors&&e.data.errors.length>pt.max&&(k.debug&&i("sending too many errors, only "+pt.max+" allowed"),e.data.errors=e.data.errors.slice(0,pt.max));for(var n in e.data)"number"==typeof e.data[n]&&(e.data[n]=String(e.data[n]));n=Math.abs(k.onlinetime),n>dt||0>=n?k.debug&&i("illegal online time: "+n):(n=r({headers:g()},e.data),St({url:t,data:n,success:function(t,n){xt.succ=1,xt.fail=0,xt.total=n,a(e.success,t,[t,n])},error:function(t,n,r){xt.succ=0,xt.fail+=1,xt.total+=n,a(e.error,t,[t,n,r]),r&&k.debug&&i("report timeout, network infomation",xt)},complete:function(t,n){y({eventid:ct,labelmap:JSON.stringify(xt),duration:"1"},et),a(e.complete,t,[t,n])}}),k.debug&&i("report data:",n))}}function h(e){e=s(e);try{var t=JSON.parse(z.getItem(e));return Array.isArray(t)?t:[]}catch(n){return z.removeItem(e),[]}}function y(e,t){t=s(t);var n=h(t);Array.isArray(e)?e.forEach(function(e){return n.push(e)}):n.push(e),z.setItem(t,JSON.stringify(n))}function I(){N.addEventListener&&N.addEventListener("error",function(e){a(function(){if(pt.isReportAllowed(e.filename)){pt.count+=1;var t={};["colno","filename","lineno","message"].forEach(function(n){return t[n]=e[n]||"0"});var n=e.error||{};t.stack=n.stack||"",t.type=n.name||"Error",t.timestamp=parseInt(e.timeStamp/1e3),y(t,tt)}})},!1)}function x(){a(function(){if(N[st])N[st]=null;else if("function"==typeof define&&define.amd)require.undef(st);else if("object"==typeof e&&"undefined"!=typeof module){var t=require.resolve(st);delete require.cache[t]}else i("unknown module system, unload DCAgent manually please");i("DCAgent has been destroyed.")})}function S(){return bt?(x(),!1):(P.hidden||(k.intervalCount+=1,X.setItem(s(rt),k.intervalCount),l()),!0)}function b(e,t){if(!Ot.isAgentReady()){var n=[e];return[].forEach.call(t,function(e){return n.push(e)}),Et.push(n),!0}}function w(e){e=s(e);try{var t=JSON.parse(z.getItem(e));return Array.isArray(t)?t:[]}catch(n){return z.removeItem(e),[]}}function O(e,t){t=s(t);var n=w(t);Array.isArray(e)?e.forEach(function(e){return n.push(e)}):n.push(e),z.setItem(t,JSON.stringify(n))}function E(e,t,n){if(e){if(!b("onEvent",arguments)){null==t&&(t=0);var r,a;if(n&&"[object Object]"===H.call(n)){for(r in n)a=n[r],n[r]=encodeURIComponent(a);r=JSON.stringify(n)}else r="";O({eventid:e,duration:String(t),labelmap:r},et)}}else i("invoke failed, missing eventId")}function C(e){b("onPageView",arguments)||f(e)}function R(e){e&&e.hasOwnProperty("amount")&&!b("onPayment",arguments)&&(e.amount=parseFloat(e.amount)||0,v({data:{payment:{currencyAmount:e.amount.toFixed(2),currencyType:e.currencyType||"CNY",payType:String(e.payType||""),iapid:String(e.iapid||""),orderId:String(e.orderId||""),payTime:String(e.payTime||"")}}},ot))}function D(e,t,n,r){t&&c(at,e),k.deviceId=e,k.accountId=k.accountId||e;var a=X.getItem(s(nt));a||(a=Date.now(),X.setItem(s(nt),a)),k.loginTime=a,a=X.getItem(s(rt)),a||(a="0",X.setItem(s(rt),a)),k.intervalCount=parseInt(a),k.interval=1e3*Math.max(10,parseFloat(n.interval||k.interval)),k.virus&&ft(e),n.errorReport&&(n.excludes&&(pt.excludes=pt.excludes.concat(n.excludes)),I()),n=null,t&&(n={isact:t,isreg:1},k.parentId&&(n.parentid=k.parentId),M.localStorage||(n.localstorage=1)),k.initializedOn=Date.now()/1e3,u(Z)||c(Z,k.initializedOn),f(null,n,function(){Ot.setReadyState(3);for(var t={onEvent:E,onPageView:C,onPayment:R},n=0,a=Et.length;a>n;n++){var i=Et[n];t[i.shift()].apply(N,i)}Et.length=0,o(S,k.interval),"function"==typeof r&&r(e)})}function A(e){function t(n){a(function(){if(0===it.indexOf(n.origin)){var r=JSON.parse(n.data);N.removeEventListener("message",t,!1),c(Z,r.crtime),e(r.id)}})}N.addEventListener("message",t,!1);var n=P.createElement("iframe");n.style.display="none",n.src=it,n.onload=function(){this.onload=null,this.parentNode.removeChild(this)};var r=function(){return P.body.appendChild(n)};P.body?r():P.addEventListener("DOMContentLoaded",r,!1)}function _(e){c(Z,parseInt(Date.now()/1e3));var t;t=M.engine.egret?K+Q:K+W,e(n(t))}var T,j=(0,eval)("this"),N=j||{},P=j.document||{},L=j.location||{},k={appId:"",deviceId:"",accountId:"",channel:"",appVer:"",interval:10,intervalCount:0,loginTime:0,debug:N.DCAGENT_DEBUG_OPEN},M={get engine(){return q},get localStorage(){return U},get sessionStorage(){return J},get postMessage(){return V},get realBrowser(){return B},get cookie(){return F}};"function"==typeof P.createElement&&(j=P.createElement("div"),j.innerHTML="<i></i>","function"==typeof j.querySelector&&(T=j.querySelector("i"),T=!!T&&"I"===T.tagName));var q={egret:"undefined"!=typeof egret},U=!!N.localStorage||!!q.egret,J=!!N.sessionStorage,V=!!N.postMessage,B=!!T,F=B&&"cookie"in P,G=N.setTimeout;q.egret&&(G=function(e,t){egret.setTimeout(e,N,t)});var H=Object.prototype.toString;T={getItem:t,setItem:t,removeItem:t};var z=M.localStorage?N.localStorage:T,X=M.sessionStorage?N.sessionStorage:T;M.engine.egret&&(z=egret.localStorage);var Y,Z="dcagent_create_time",K="ND",Q="EGRET",W="UE",$="dcagent_parent_id",et="dcagent_client_events",tt="dcagent_client_errors",nt="dcagent_login_time",rt="dcagent_interval_key",at="dcagent_client_id",ot="http://rd.gdatacube.net/dc/html5/sync",it="http://rd.gdatacube.net/dc/html5/whoami",ct="_DESelf_OSS",ut=3e4,st="DCAgent",dt=172800,lt=Y=M.cookie?{get:function(e){return(e=P.cookie.match(new RegExp("(^|)\\s*"+e+"=([^\\s]*)")))&&3<=e.length?decodeURIComponent(e[2]):null},set:function(e,t,n,r,a,o){var i;n&&(i=new Date,i.setTime(i.getTime()+864e5*n)),n=n?" expires="+i.toGMTString():"",a=" path="+(a||"/"),r=r?" domain="+r:"",o=o?" secure":"",P.cookie=e+"="+encodeURIComponent(t)+n+a+r+o},remove:function(e,t,n){Y.set(e,"",-1,t,n)}}:{get:t,set:t,remove:t},ft=M.realBrowser?d:t,gt={max:100,count:0,excludes:[],isReportAllowed:function(e){return gt.count<gt.max?gt.excludes.every(function(t){return-1===e.indexOf(t)}):void 0}},pt=gt,mt=0,vt=M.realBrowser?L.pathname+L.search:"/",ht="14";e.version=ht,T=N.screen||{};var yt=T.width?T.width+"*"+T.height:"0*0",It=P.domain||"",xt={succ:0,fail:0,total:0},St=function(){return N.XMLHttpRequest?p:M.engine.egret?m:(i("unknow platform, http request is not support"),t)}(),bt=!1;e.teardown=function(){bt=!0};var wt=0,Ot={getReadyState:function(){return wt},setReadyState:function(e){wt=e},isAgentReady:function(){return 3===wt}},Et=[];e.onEvent=E,e.onPageView=C,e.onPayment=R;var Ct=M.postMessage&&M.realBrowser?A:_;e.init=function(e,t){if(0<Ot.getReadyState())i("DCAgent.init should be called only once");else if(e=e||{},e.appId){["errorReport","virus"].forEach(function(t){return k[t]=e.hasOwnProperty(t)?!!e[t]:!0}),["appId","accountId","appVer"].forEach(function(t){return k[t]=e[t]||""}),k.channel=e.channel||P.referrer||"";var n=u(at);n?D(n,0,e,t):(Ot.setReadyState(1),Ct(function(n){Ot.setReadyState(2),D(n,1,e,t)}))}else i("init failed, missing appId")},T=Ot.isAgentReady,Object.defineProperty(e,"readyState",{get:function(){return i("DCAgent.readyState is obsolete, use DCAgent.isReady() instead"),Ot.getReadyState()}}),e.isReady=T});var __define=this.__define||function(e,t,n,r){Object.defineProperty(e,t,{configurable:!0,enumerable:!0,get:n,set:r})};